<!DOCTYPE html>
<html lang="it">
    <head>
        <title>Prova Firma Digitale</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="style.css">
    </head>
    <body>
        <header>
         <div class="logo">Logo</div>
         
    <a href="#menu" class="menu-link"></a>
    <nav id="menu" class="menu">
        <a href="#" class="menu-link menu-close"></a>
        <ul class="nav-links">
            <li><a href="index.html">Firma il tuo PDF</a></li>
            <li><a href="verifica.html">Verifica File</a></li>
            <li><a href="about.html">Chi Siamo</a></li>
            <li><a href="contact.html">Contatti</a></li>
        </ul>
    </nav>
    </header>
    <main>
            <div class="container">
                <div class="glass-card">
                    <h1>Firma Digitale</h1>
                    <p class="subtitle">Carica il documento al quale vuoi apporre una firma crittografica protetta da encryption RSA-PSS:</p>
                    <div class="upload-area">
                        <form method="post" action="/sign" enctype="multipart/form-data">
                            <label for="file" class="file-label">Scegli il PDF</label>
                            <input id="file" type="file" name="file" />
                            <input type="submit" value="Firma!" disabled />
                        </form>
                    </div>

                    <div id="result"></div>
                    <div id="download-links">
                        <div id="download-link-firma"></div>
                        <div id="download-link-chiave-pubblica"></div>
                    </div>
                </div>
            </div>
        </main>

        <script>
            const bottone = document.querySelector('input[type="submit"]');
            const fileInput = document.querySelector('input[type="file"]');
            const form = document.querySelector('form');

            // Abilita il pulsante solo quando un file Ã¨ selezionato
            fileInput.addEventListener('change', () => {
                if (fileInput.files.length > 0) {
                    bottone.disabled = false;
                } else {
                    bottone.disabled = true;
                }
            });

            // Gestione dell'invio del modulo
            form.addEventListener('submit', async (event) => {
                event.preventDefault();

                // Pulizia dei link di download precedenti
                document.getElementById('download-link-firma').innerHTML = '';
                document.getElementById('download-link-chiave-pubblica').innerHTML = '';
                
                const selectedFile = form.querySelector('input[type="file"]').files[0];

                // Validazione del file
                if (selectedFile.type !== 'application/pdf') {
                    alert('Selezionare un file PDF');
                    return;
                } else if (selectedFile.size > 10 * 1024 * 1024) {
                    alert('Il file supera la dimensione massima di 10MB');
                    return;
                }

                // Invio richiesta al server 
                const formData = new FormData();
                formData.append('file', selectedFile);

                try {
                    const risposta = await fetch('http://localhost:3000/sign', {
                        method: 'POST',
                        body: formData
                    });
                const risultato = await risposta.json();

                // Mostra messaggio di successo
                document.getElementById('result').innerText =
                'Firma digitale creata con successo!';

                // Crea blob per il download della firma
                const firmaBytes = Uint8Array.from(
                    atob(risultato.signature),
                    c => c.charCodeAt(0)
                );
                const firma = new Blob([firmaBytes],
                { type: 'application/octet-stream' });

                // Crea blob per il download della chiave pubblica
                const chiavePubblica = new Blob([risultato.publicKeyPem],
                { type: 'text/plain' });
                
                // Genera i link di download
                creaLinkDownload(firma, 'firma.sig', 'Scarica Firma Digitale', 'download-link-firma');
                creaLinkDownload(chiavePubblica, 'chiave_pubblica.pem', 'Scarica Chiave Pubblica', 'download-link-chiave-pubblica');
            
                } catch (err) {
                document.getElementById('result').innerText = 
                'Errore: ' + err.message;
                }
            });
                // Funzione helper per creare i link di download
                function creaLinkDownload(blob, nomeFile, testoLink, idElemento) {
                    const url = URL.createObjectURL(blob);
                    const downloadLink = document.createElement('a');
                    downloadLink.href = url;
                    downloadLink.download = nomeFile;
                    downloadLink.innerText = testoLink;
                    document.getElementById(idElemento).appendChild(downloadLink);
                }
    </script>

</body>
</html>